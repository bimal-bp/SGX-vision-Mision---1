<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Multilingual Speech to Text – SGX Minerals</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
/* ---- ALL YOUR ORIGINAL STYLES (unchanged) ---- */
* {margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;}
body {background:#f5f7fa;color:#333;min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:2rem;}
.container {max-width:900px;width:100%;background:#fff;border-radius:12px;padding:2rem;box-shadow:0 8px 25px rgba(0,0,0,.1);border:1px solid #e1e8ed;}
header {text-align:center;margin-bottom:2rem;}
h1 {font-size:2.2rem;margin-bottom:.5rem;background:linear-gradient(135deg,#3498db,#2c3e50);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.subtitle {font-size:1.1rem;color:#7f8c8d;}
.language-section,.name-section,.audio-prompt {background:#f8f9fa;border-radius:10px;padding:1.5rem;margin-bottom:1.5rem;text-align:center;border-left:4px solid #3498db;}
.language-section h2,.name-section h2 {margin-bottom:1rem;color:#2c3e50;}
.language-selector {display:flex;gap:15px;justify-content:center;flex-wrap:wrap;margin-top:1rem;}
.lang-btn {padding:.7rem 1.2rem;font-size:1rem;border:2px solid #3498db;border-radius:8px;cursor:pointer;transition:.3s;background:#fff;color:#3498db;font-weight:600;}
.lang-btn.active,.lang-btn:hover {background:#3498db;color:#fff;}
.name-input {display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:1rem;}
.name-input input {padding:.8rem 1rem;border-radius:8px;border:1px solid #ddd;font-size:1rem;width:250px;}
button {padding:.8rem 1.5rem;font-size:1rem;border:none;border-radius:8px;cursor:pointer;transition:.3s;font-weight:600;}
#submit-name {background:#3498db;color:#fff;}
#submit-name:hover {background:#2980b9;}
.controls {display:flex;gap:1rem;margin-bottom:2rem;justify-content:center;flex-wrap:wrap;}
#start-btn {background:#2ecc71;color:#fff;}
#stop-btn {background:#e74c3c;color:#fff;}
#save-btn {background:#3498db;color:#fff;}
#clear-btn {background:#95a5a6;color:#fff;}
#translate-btn {background:#9b59b6;color:#fff;}
button:hover {transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.1);}
button:disabled {opacity:.6;cursor:not-allowed;transform:none;box-shadow:none;}
.status {text-align:center;margin-bottom:1.5rem;font-size:1.1rem;height:1.5rem;color:#7f8c8d;}
.speaker-info {text-align:center;margin-bottom:1rem;font-size:1.2rem;color:#2c3e50;font-weight:600;}
.language-info {text-align:center;margin-bottom:1rem;font-size:1rem;color:#7f8c8d;}
.output-container {background:#fff;border-radius:10px;padding:1.5rem;min-height:300px;margin-bottom:1.5rem;overflow-y:auto;max-height:400px;border:1px solid #e0e0e0;box-shadow:inset 0 2px 4px rgba(0,0,0,.05);}
#transcript {font-size:1.2rem;line-height:1.6;min-height:200px;}
.translated-text {margin-top:1rem;padding:1rem;background:#f8f9fa;border-radius:8px;border-left:4px solid #9b59b6;}
.translated-text h4 {color:#9b59b6;margin-bottom:.5rem;}
.visualizer {height:80px;margin:1.5rem 0;display:flex;justify-content:center;align-items:center;gap:3px;}
.bar {width:6px;background:#3498db;border-radius:5px;transition:height .1s;}
.saved-transcripts h3 {margin-bottom:1rem;color:#2c3e50;border-bottom:1px solid #e0e0e0;padding-bottom:.5rem;}
.transcript-list {max-height:200px;overflow-y:auto;}
.transcript-item {background:#fff;padding:1rem;border-radius:8px;margin-bottom:.5rem;border:1px solid #e0e0e0;}
.transcript-header {display:flex;justify-content:space-between;margin-bottom:.5rem;}
.transcript-name {font-weight:bold;color:#3498db;}
.transcript-content {font-size:.9rem;color:#555;}
.delete-btn {background:#e74c3c;color:#fff;border:none;border-radius:5px;padding:.3rem .6rem;cursor:pointer;font-size:.8rem;}
.hidden {display:none;}
@media (max-width:600px){
    .container{padding:1.5rem;}
    h1{font-size:1.8rem;}
    .controls{flex-direction:column;align-items:center;}
    button{width:100%;}
    .name-input{flex-direction:column;align-items:stretch;}
    .name-input input{width:100%;margin-bottom:10px;}
    .language-selector{flex-direction:column;}
}
</style>
</head>
<body>
<div class="container">
    <header>
        <h1>Multilingual Speech to Text</h1>
        <p class="subtitle">Speak in English or Hindi – real-time transcription</p>
    </header>

    <!-- ==== LANGUAGE SELECTION ==== -->
    <div class="language-section" id="language-section">
        <h2>Choose Your Language</h2>
        <p>Select the language you want to use for speech recognition</p>
        <div class="language-selector">
            <button class="lang-btn active" data-lang="en-US">English</button>
            <button class="lang-btn" data-lang="hi-IN">Hindi</button>
        </div>
    </div>

    <!-- ==== NAME INPUT (hidden until language chosen) ==== -->
    <div class="name-section hidden" id="name-section">
        <h2 id="name-prompt">Please tell us your name</h2>
        <p id="name-instruction">We'll use this to save your transcripts</p>

        <div class="audio-prompt" id="audio-prompt">
            <h4 id="speak-name-title">Speak Your Name</h4>
            <p id="audio-instruction">Click the button below and say your name</p>
            <button id="listen-name-btn">Listen for Name</button>
            <div class="status" id="name-status">Ready to listen for your name</div>
        </div>

        <div class="name-input">
            <input type="text" id="speaker-name" placeholder="Enter your name">
            <button id="submit-name">Submit Name</button>
        </div>
    </div>

    <!-- ==== MAIN UI (hidden until name entered) ==== -->
    <div id="main-section" class="hidden">
        <div class="speaker-info" id="speaker-info"></div>
        <div class="language-info" id="language-info"></div>

        <div class="controls">
            <button id="start-btn">Start Listening</button>
            <button id="stop-btn" disabled>Stop Listening</button>
            <button id="translate-btn">Translate Text</button>
            <button id="save-btn">Save Transcript</button>
            <button id="clear-btn">Clear Text</button>
        </div>

        <div class="status" id="status">Press “Start Listening” to begin</div>

        <div class="visualizer" id="visualizer"></div>

        <div class="output-container">
            <div id="transcript">Your transcribed text will appear here...</div>
            <div class="translated-text hidden" id="translated-text">
                <h4>Translated Text:</h4>
                <div id="translation-result"></div>
            </div>
        </div>

        <div class="saved-transcripts">
            <h3>Saved Transcripts</h3>
            <div class="transcript-list" id="transcript-list"></div>
        </div>
    </div>
</div>

<script>
/* ==============================================================
   GLOBAL VARIABLES & HELPERS
   ============================================================== */
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);

let speakerName = '';
let selectedLanguage = 'en-US';
let isListening = false;
let isListeningForName = false;
let currentTranscript = '';

const recognition = ('SpeechRecognition' in window) ? new SpeechRecognition() : new webkitSpeechRecognition();
const nameRecognition = ('SpeechRecognition' in window) ? new SpeechRecognition() : new webkitSpeechRecognition();

recognition.continuous = true;
recognition.interimResults = true;
nameRecognition.continuous = false;
nameRecognition.interimResults = false;

/* ---- LANGUAGE MAPS (texts) ---- */
const langMap = { 'en-US':'English', 'hi-IN':'Hindi' };
const welcomeMsg = { 'en-US':'Welcome to SGX Minerals. Please tell me your name.',
                    'hi-IN':'एसजीएक्स मिनरल्स में आपका स्वागत है। कृपया अपना नाम बताएं।' };
const namePrompts = { 'en-US':'Please tell us your name', 'hi-IN':'अपना नाम बताएं' };
const nameInstr  = { 'en-US':'We\'ll use this to save your transcripts',
                    'hi-IN':'हम इसे आपके ट्रांसक्रिप्ट को सहेजने के लिए उपयोग करेंगे' };
const speakTitle = { 'en-US':'Speak Your Name', 'hi-IN':'अपना नाम बोलें' };
const audioInstr = { 'en-US':'Click the button below and say your name',
                    'hi-IN':'नीचे दिए गए बटन पर क्लिक करें और अपना नाम बोलें' };
const nameStatus = {
    'en-US':{ready:'Ready to listen for your name',listening:'Listening… say your name',success:'Name captured!',error:'Could not understand. Try again'},
    'hi-IN':{ready:'आपका नाम सुनने के लिए तैयार',listening:'सुन रहा हूं… अपना नाम बोलें',success:'नाम सफलतापूर्वक कैप्चर!',error:'समझ नहीं आया। फिर कोशिश करें'}
};
const btnTexts = {
    start:{'en-US':'Start Listening','hi-IN':'सुनना शुरू करें'},
    stop:{'en-US':'Stop Listening','hi-IN':'सुनना बंद करें'},
    translate:{'en-US':'Translate Text','hi-IN':'टेक्स्ट अनुवाद करें'},
    save:{'en-US':'Save Transcript','hi-IN':'ट्रांसक्रिप्ट सहेजें'},
    clear:{'en-US':'Clear Text','hi-IN':'टेक्स्ट साफ करें'},
    listenName:{'en-US':'Listen for Name','hi-IN':'नाम सुनें'},
    submit:{'en-US':'Submit Name','hi-IN':'नाम सबमिट करें'}
};
const placeholders = {'en-US':'Enter your name','hi-IN':'अपना नाम दर्ज करें'};

/* ---- UI ELEMENTS ---- */
const langBtns          = $$('.lang-btn');
const nameSection       = $('#name-section');
const mainSection       = $('#main-section');
const speakerInfo       = $('#speaker-info');
const languageInfo      = $('#language-info');
const transcriptDiv     = $('#transcript');
const statusDiv         = $('#status');
const nameStatusDiv     = $('#name-status');
const visualizer        = $('#visualizer');
const transcriptList    = $('#transcript-list');

/* ---- CREATE VISUALIZER BARS ---- */
for(let i=0;i<30;i++){
    const bar = document.createElement('div');
    bar.className='bar';
    bar.style.height='5px';
    visualizer.appendChild(bar);
}
const bars = $$('.bar');

/* ==============================================================
   LANGUAGE SELECTION
   ============================================================== */
langBtns.forEach(btn=>{
    btn.addEventListener('click',()=>{
        langBtns.forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        selectedLanguage = btn.dataset.lang;

        recognition.lang = nameRecognition.lang = selectedLanguage;

        updateAllTexts();
        nameSection.classList.remove('hidden');
        mainSection.classList.add('hidden');

        // ---- WELCOME VOICE + AUTO START NAME LISTENING ----
        speak(welcomeMsg[selectedLanguage], selectedLanguage, ()=>{
            startNameListening();
        });
    });
});

/* ==============================================================
   NAME INPUT (speech or manual)
   ============================================================== */
$('#listen-name-btn').addEventListener('click', startNameListening);
$('#submit-name').addEventListener('click', submitName);
$('#speaker-name').addEventListener('keypress', e=>{ if(e.key==='Enter') submitName(); });

function submitName(){
    const manual = $('#speaker-name').value.trim();
    if(!manual && !speakerName){ alert('Please enter or speak your name'); return; }
    speakerName = manual || speakerName;
    speakerInfo.textContent = `Speaker: ${speakerName}`;
    languageInfo.textContent = `Language: ${langMap[selectedLanguage]}`;
    nameSection.classList.add('hidden');
    mainSection.classList.remove('hidden');
    loadSavedTranscripts();
    setTimeout(startListening,800);
}

/* ---- NAME RECOGNITION ---- */
nameRecognition.onresult = e=>{
    speakerName = e.results[0][0].transcript.trim();
    $('#speaker-name').value = speakerName;
    nameStatusDiv.textContent = nameStatus[selectedLanguage].success;
    stopNameListening();
    setTimeout(submitName,800);
};
nameRecognition.onerror = e=>{
    console.error(e);
    nameStatusDiv.textContent = nameStatus[selectedLanguage].error;
    stopNameListening();
};
nameRecognition.onend = ()=> stopNameListening();

/* ==============================================================
   MAIN LISTENING
   ============================================================== */
$('#start-btn').addEventListener('click', startListening);
$('#stop-btn').addEventListener('click', stopListening);
$('#clear-btn').addEventListener('click',()=>{ transcriptDiv.textContent=''; currentTranscript=''; $('#translated-text').classList.add('hidden'); });
$('#save-btn').addEventListener('click',()=>{ if(currentTranscript.trim()) saveTranscript(); else alert('Nothing to save'); });
$('#translate-btn').addEventListener('click', translateText);

/* ---- RECOGNITION HANDLERS ---- */
recognition.onresult = e=>{
    let final = '', interim = '';
    for(let i=e.resultIndex;i<e.results.length;i++){
        const t = e.results[i][0].transcript;
        if(e.results[i].isFinal){
            final += t;
            const low = t.toLowerCase();
            if(low.includes('stop')||low.includes('stop listening')){ stopListening(); return; }
        }else interim += t;
    }
    currentTranscript = final + interim;
    transcriptDiv.innerHTML = final + `<i style="color:#e74c3c">${interim}</i>`;
};
recognition.onerror = e=>{
    console.error(e);
    statusDiv.textContent = `Error: ${e.error}`;
    stopListening();
};
recognition.onend = ()=>{
    if(isListening) recognition.start();
    else { $('#start-btn').disabled=false; $('#stop-btn').disabled=true; }
};

/* ==============================================================
   HELPERS
   ============================================================== */
function updateAllTexts(){
    $('#name-prompt').textContent = namePrompts[selectedLanguage];
    $('#name-instruction').textContent = nameInstr[selectedLanguage];
    $('#speak-name-title').textContent = speakTitle[selectedLanguage];
    $('#audio-instruction').textContent = audioInstr[selectedLanguage];
    nameStatusDiv.textContent = nameStatus[selectedLanguage].ready;

    $('#start-btn').textContent = btnTexts.start[selectedLanguage];
    $('#stop-btn').textContent = btnTexts.stop[selectedLanguage];
    $('#translate-btn').textContent = btnTexts.translate[selectedLanguage];
    $('#save-btn').textContent = btnTexts.save[selectedLanguage];
    $('#clear-btn').textContent = btnTexts.clear[selectedLanguage];
    $('#listen-name-btn').textContent = btnTexts.listenName[selectedLanguage];
    $('#submit-name').textContent = btnTexts.submit[selectedLanguage];
    $('#speaker-name').placeholder = placeholders[selectedLanguage];
}

function speak(text, lang, onEnd){
    if(!('speechSynthesis' in window)) return onEnd?.();
    const ut = new SpeechSynthesisUtterance(text);
    ut.lang = lang;
    ut.rate = 0.9;
    ut.onend = onEnd;
    speechSynthesis.cancel();
    speechSynthesis.speak(ut);
}

function startNameListening(){
    if(isListeningForName) return;
    nameRecognition.lang = selectedLanguage;
    speak(audioInstr[selectedLanguage], selectedLanguage, ()=>{
        nameRecognition.start();
        $('#listen-name-btn').disabled = true;
        nameStatusDiv.textContent = nameStatus[selectedLanguage].listening;
        isListeningForName = true;
    });
}
function stopNameListening(){
    nameRecognition.stop();
    $('#listen-name-btn').disabled = false;
    isListeningForName = false;
}

function startListening(){
    if(isListening) return;
    recognition.lang = selectedLanguage;
    recognition.start();
    $('#start-btn').disabled = true;
    $('#stop-btn').disabled = false;
    statusDiv.textContent = `Listening in ${langMap[selectedLanguage]}…`;
    transcriptDiv.textContent = '';
    currentTranscript = '';
    isListening = true;
    animateBars();
}
function stopListening(){
    if(!isListening) return;
    recognition.stop();
    $('#start-btn').disabled = false;
    $('#stop-btn').disabled = true;
    statusDiv.textContent = 'Stopped.';
    isListening = false;
    if(currentTranscript.trim()){
        const ts = new Date().toLocaleString();
        const key = `${speakerName} - ${ts} (${langMap[selectedLanguage]})`;
        saveTranscript(key, currentTranscript);
        statusDiv.textContent = 'Stopped & saved.';
    }
}

/* ---- VISUALIZER ---- */
function animateBars(){
    if(!isListening) return;
    bars.forEach(b=>b.style.height = `${Math.random()*70+5}px`);
    setTimeout(animateBars,100);
}

/* ---- LOCAL STORAGE (per speaker) ---- */
function saveTranscript(key, text){
    const store = JSON.parse(localStorage.getItem('sgxTranscripts')||'{}');
    store[key] = text;
    localStorage.setItem('sgxTranscripts', JSON.stringify(store));
    loadSavedTranscripts();
    statusDiv.textContent = 'Saved!';
}
function loadSavedTranscripts(){
    const store = JSON.parse(localStorage.getItem('sgxTranscripts')||'{}');
    transcriptList.innerHTML = '';
    let found = false;
    for(const [k, v] of Object.entries(store)){
        if(k.startsWith(speakerName)){
            found = true;
            const item = document.createElement('div');
            item.className='transcript-item';
            const header = document.createElement('div');
            header.className='transcript-header';
            const name = document.createElement('div');
            name.className='transcript-name';
            name.textContent = k;
            const del = document.createElement('button');
            del.className='delete-btn';
            del.textContent='Delete';
            del.onclick=()=>deleteTranscript(k);
            header.append(name,del);
            const content = document.createElement('div');
            content.className='transcript-content';
            content.textContent = v.length>100 ? v.slice(0,100)+'...' : v;
            item.append(header,content);
            transcriptList.appendChild(item);
        }
    }
    if(!found) transcriptList.innerHTML = '<p>No saved transcripts yet.</p>';
}
function deleteTranscript(key){
    if(!confirm(`Delete "${key}"?`)) return;
    const store = JSON.parse(localStorage.getItem('sgxTranscripts')||'{}');
    delete store[key];
    localStorage.setItem('sgxTranscripts', JSON.stringify(store));
    loadSavedTranscripts();
}

/* ---- TRANSLATION (MyMemory – free) ---- */
async function translateText(){
    if(!currentTranscript.trim()){ alert('Nothing to translate'); return; }
    statusDiv.textContent='Translating…';
    try{
        const src = selectedLanguage.split('-')[0];
        const resp = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(currentTranscript)}&langpair=${src}|en`);
        const data = await resp.json();
        if(data.responseStatus===200){
            $('#translation-result').textContent = data.responseData.translatedText;
            $('#translated-text').classList.remove('hidden');
            statusDiv.textContent='Translated.';
        }else throw new Error();
    }catch{
        statusDiv.textContent='Translation failed.';
    }
}
</script>
</body>
</html>
